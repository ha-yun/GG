<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1:1 ì‹¤ì‹œê°„ ì±„íŒ…</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>1:1 ì‹¤ì‹œê°„ ì±„íŒ…</h1>

<label>ë‚´ ID:</label>
<input type="text" id="myId" placeholder="ë‚´ ID ì…ë ¥">
<br>
<label>ìƒëŒ€ë°© ID:</label>
<input type="text" id="receiverId" placeholder="ìƒëŒ€ë°© ID ì…ë ¥">
<br>
<input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
<button onclick="sendMessage()">ì „ì†¡</button>

<h3>ì±„íŒ… ë¡œê·¸:</h3>
<ul id="chat-log"></ul>

<script>
  let socket = new SockJS('http://localhost:8080/ws-chat');
  let stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log('âœ… WebSocket ì—°ê²°ë¨: ' + frame);

    let myIdInput = document.getElementById("myId");
    let chatLog = document.getElementById("chat-log");

    if (!chatLog) {
      console.error("âŒ ì±„íŒ… ë¡œê·¸ ìš”ì†Œ(chat-log)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // ê¸°ì¡´ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch("/api/chat/history")
            .then(response => response.json())
            .then(messages => {
              messages.forEach(msg => {
                let parsedMsg = JSON.parse(msg);
                let newMessage = document.createElement("li");
                newMessage.textContent = `${parsedMsg.senderId}: ${parsedMsg.msg}`;
                chatLog.appendChild(newMessage);
              });
            });

    // ì‚¬ìš©ìê°€ ID ì…ë ¥ í›„ êµ¬ë…í•  ìˆ˜ ìˆë„ë¡ ì´ë²¤íŠ¸ ì¶”ê°€
    myIdInput.addEventListener("change", function () {
      let myId = myIdInput.value;
      console.log(`ğŸŸ¢ êµ¬ë…í•˜ëŠ” ê²½ë¡œ: /topic/chat/${myId}`);

      stompClient.subscribe(`/topic/chat/${myId}`, function (message) {
        let data = JSON.parse(message.body);
        let newMessage = document.createElement("li");
        newMessage.textContent = `${data.senderId}: ${data.msg}`;
        chatLog.appendChild(newMessage);
      });
    });
  });

  // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
  function sendMessage() {
    let myId = document.getElementById("myId").value;
    let receiverId = document.getElementById("receiverId").value;
    let message = document.getElementById("message").value;

    if (!myId || !receiverId || !message) {
      alert("âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }

    let chatMessage = {
      senderId: myId,
      receiverId: receiverId,
      msg: message
    };

    if (stompClient && stompClient.connected) {
      stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
      console.log("ğŸ“¨ ë©”ì‹œì§€ ì „ì†¡ë¨:", chatMessage);
    } else {
      console.error("âŒ WebSocket ì—°ê²°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
  }
</script>

</body>
</html>
