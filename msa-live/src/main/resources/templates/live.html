<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>실시간 채팅</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>스타-팬 실시간 채팅</h2>
<div id="chatBox"></div>
<input type="text" id="messageInput" placeholder="메시지를 입력하세요">
<button onclick="sendMessage()">전송</button>

<script>
  let socket = new SockJS('/ws');
  let stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log("웹소켓 Connected: " + frame);

    // 🔹 기존 채팅 기록 불러오기
    fetch("/api/chat/history")
            .then(response => response.json())
            .then(messages => {
              let chatBox = document.getElementById("chatBox");
              messages.forEach(msg => {
                let newMessage = document.createElement("p");
                newMessage.textContent = msg;
                chatBox.appendChild(newMessage);
              });
            });

    // 실시간 메세지 수신
    stompClient.subscribe('/topic/messages', function (message) {
      console.log("📩 받은 메시지:", message.body);
      let chatBox = document.getElementById("chatBox");
      let newMessage = document.createElement("p");
      newMessage.textContent = message.body;
      chatBox.appendChild(newMessage);
    });
  },function (error) {
    console.log("❌ 웹소켓 연결 실패!",error);
  });

  function sendMessage() {
    let msg = document.getElementById("messageInput").value;
    console.log("📤 메시지 전송:", msg);
    stompClient.send("/app/send", {}, msg);
    document.getElementById("messageInput").value = ""; // 입력 필드 초기화
  }
</script>
</body>
</html>
